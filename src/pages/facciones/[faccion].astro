---
import Layout from "../../layouts/Layout.astro";
import ChampionCard from "../../components/champion/ChampionCard.astro"; // Ajusta si tu componente est√° en otra ruta

import champions from "../../data/champions.json";
import factionsList from "../../data/factions.json";

interface Champion {
  slug: string;
  name: string;
  rarity: string;
  faction: string;
  type: string;
  affinity: string;
  image: string;
}

interface FactionData {
  name: string;
  slug: string;
  image: string;
}

interface Props {
  factionName: string;
  factionData: FactionData;
  groupedChampions: Record<string, Champion[]>;
  allChampions: Champion[];
}

export async function getStaticPaths() {
  // Recorremos la lista de facciones para crear una p√°gina por cada una
  return factionsList.map((factionData) => {
    // 1. Generamos el SLUG (URL) en min√∫sculas y con guiones
    // Ejemplo: "Orden Sagrada" -> "orden-sagrada"
    const slug = factionData.name.toLowerCase().replace(/\s+/g, "-");

    // 2. Filtramos los campeones usando el NOMBRE EXACTO (con may√∫sculas/espacios)
    // Comparamos factionData.name ("Orden Sagrada") con champion.faction ("Orden Sagrada")
    const factionChampions = champions.filter(
      (c) => c.faction === factionData.name,
    );

    // 3. Orden de Rareza y Afinidad
    const rarityOrder = [
      "M√≠tico",
      "Legendario",
      "√âpico",
      "Raro",
      "Poco Com√∫n",
      "Com√∫n",
    ];
    const affinityOrder = ["Esp√≠ritu", "Magia", "Fuerza", "Vac√≠o"];

    // 4. Agrupar por Rareza
    const groupedChampions: Record<string, typeof champions> = {};
    rarityOrder.forEach((rarity) => {
      const champsInRarity = factionChampions.filter(
        (c) => c.rarity === rarity,
      );
      if (champsInRarity.length > 0) {
        // 5. Ordenar por Afinidad dentro de cada Rareza
        champsInRarity.sort((a, b) => {
          return (
            affinityOrder.indexOf(a.affinity) -
            affinityOrder.indexOf(b.affinity)
          );
        });
        groupedChampions[rarity] = champsInRarity;
      }
    });

    return {
      params: { faccion: slug }, // La URL ser√° /facciones/orden-sagrada
      props: {
        factionName: factionData.name, // Pasamos el nombre bonito ("Orden Sagrada")
        factionData: factionData,
        groupedChampions: groupedChampions, // Pasamos los campeones agrupados y ordenados
        allChampions: factionChampions, // Mantenemos la lista plana para filtros si es necesario
      },
    };
  });
}

import { getRarityStyle } from "../../utils/rarity";

// Recuperamos las props
const { factionName, factionData, groupedChampions, allChampions } =
  Astro.props as Props;
const factionImage = factionData?.image || "/favicon.png";
---
<Layout title={`${factionName} - Campeones`}>
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <div
      class="flex flex-col md:flex-row items-center gap-8 mb-12 bg-gray-900/80 p-8 rounded-2xl border border-gray-800 shadow-2xl"
    >
      <img
        src={factionImage}
        alt={factionName}
        class="w-32 h-32 object-contain drop-shadow-[0_0_15px_rgba(255,215,0,0.2)]"
      />
      <div class="text-center md:text-left">
        <h1
          class="text-4xl md:text-6xl font-black text-white uppercase tracking-tighter mb-2"
        >
          {factionName}
        </h1>
        <p class="text-gray-400 text-lg max-w-2xl">
          Explorando <span class="text-raid-gold font-bold"
            >{allChampions.length}</span
          > campeones de esta facci√≥n.
        </p>
      </div>
    </div>

    <div
      class="bg-gray-800/50 p-6 rounded-xl border border-gray-700 mb-8 sticky top-4 z-30 backdrop-blur-md shadow-lg"
    >
      <div
        class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4"
      >
        <h2 class="text-lg font-bold text-white flex items-center gap-2">
          üîç Buscar Campe√≥n
        </h2>
      </div>

      <div>
        <input
          type="text"
          id="filterSearch"
          placeholder="Buscar por nombre..."
          class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-2.5 text-sm text-gray-200 placeholder-gray-500 focus:border-raid-gold focus:ring-1 focus:ring-raid-gold outline-none"
        />
      </div>
    </div>

    <div id="championsContainer">
      {
        Object.entries(groupedChampions).map(([rarity, champions]) => {
          const style = getRarityStyle(rarity);
          const colorClass = `${style.text} ${style.border}/30`;
          return (
            <div class="mb-12 rarity-group" data-rarity-group={rarity}>
              <h2
                class={`text-2xl font-bold mb-6 border-b pb-2 uppercase tracking-wider flex items-center gap-2 ${colorClass}`}
              >
                {rarity}
              </h2>

              <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6 justify-items-center">
                {champions.map((champion) => (
                  <div
                    class="champion-card transition-all duration-300 hover:-translate-y-1 w-full flex justify-center"
                    data-name={champion.name.toLowerCase()}
                    data-rarity={champion.rarity}
                    data-affinity={champion.affinity}
                    data-type={champion.type}
                  >
                    <ChampionCard champion={champion} />
                  </div>
                ))}
              </div>
            </div>
          );
        })
      }
    </div>

    <div
      id="noResults"
      class="hidden text-center py-20 bg-gray-800/30 rounded-xl border border-dashed border-gray-700"
    >
      <p class="text-2xl text-gray-500 font-bold mb-2">ü§∑‚Äç‚ôÇÔ∏è No hay campeones</p>
      <p class="text-gray-400">Intenta con otro nombre.</p>
    </div>
  </main>

  <script is:inline>
    (function () {
      console.log("Initializing Faction Search Script...");

      function initSearch() {
        const filterSearch = document.getElementById("filterSearch");
        const noResults = document.getElementById("noResults");
        const rarityGroups = document.querySelectorAll(".rarity-group");

        if (!filterSearch) {
          console.error("Search input #filterSearch not found!");
          return;
        }

        console.log("Search input found, attaching listener.");

        filterSearch.addEventListener("input", (e) => {
          const sVal = e.target.value.toLowerCase();
          console.log("Filtering for:", sVal);

          let totalVisibleCards = 0;

          rarityGroups.forEach((group) => {
            const cards = group.querySelectorAll(".champion-card");
            let groupVisibleCount = 0;

            cards.forEach((card) => {
              const cName = card.getAttribute("data-name") || "";
              // Normalizamos strings para evitar problemas con tildes, etc.
              const match = !sVal || cName.includes(sVal);

              if (match) {
                card.classList.remove("hidden");
                card.classList.add("flex");
                groupVisibleCount++;
              } else {
                card.classList.add("hidden");
                card.classList.remove("flex");
              }
            });

            // Mostrar/Ocultar el grupo entero (Header + Grid)
            if (groupVisibleCount > 0) {
              group.classList.remove("hidden");
              totalVisibleCards += groupVisibleCount;
            } else {
              group.classList.add("hidden");
            }
          });

          // Mostrar mensaje si no hay resultados
          if (noResults) {
            if (totalVisibleCards === 0) {
              noResults.classList.remove("hidden");
            } else {
              noResults.classList.add("hidden");
            }
          }
        });
      }

      // Ejecutar cuando el DOM est√© listo
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initSearch);
      } else {
        initSearch();
      }
    })();
  </script>
</Layout>
